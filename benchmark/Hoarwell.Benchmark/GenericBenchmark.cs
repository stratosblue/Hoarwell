// <Auto-Generated/>

using System.Text;
using BenchmarkDotNet.Attributes;
using Hoarwell.Benchmark;

namespace Hoarwell;

[SimpleJob]
[MemoryDiagnoser]
public class GenericBenchmark
{
    private ServerBaseOnHoarwell _serverBaseOnHoarwell;
    private ServerBaseOnDotNetty _serverBaseOnDotNetty;

    private ClientBaseOnHoarwell _clientBaseOnHoarwell;
    private ClientBaseOnDotNetty _clientBaseOnDotNetty;

    public const int HoarwellPort = 11234;
    public const int DotNettyPort = 11235;

    private readonly Dictionary<int, string> _contentCache = [];

    [Params(1, 100)]
    public int EchoCount { get; set; }

    [Params(32, 1024)]
    public int ContentSize { get; set; }

    public GenericBenchmark()
    {
        _contentCache.Add(32, BuildContentString(32));
        _contentCache.Add(1024, BuildContentString(1024));
    }

    [Benchmark]
    public async Task Hoarwell()
    {
        var message = _contentCache[ContentSize];
        for (int i = 0; i < EchoCount; i++)
        {
            await _clientBaseOnHoarwell.WriteAndFlushAsync(new EchoData() { Id = i, Message = message });
        }

        await _clientBaseOnHoarwell.WaitCompleteAndResetAsync();
    }

    [Benchmark(Baseline = true)]
    public async Task DotNetty()
    {
        var message = _contentCache[ContentSize];
        for (int i = 0; i < EchoCount; i++)
        {
            await _clientBaseOnDotNetty.WriteAndFlushAsync(new EchoData() { Id = i, Message = message });
        }

        await _clientBaseOnDotNetty.WaitCompleteAndResetAsync();
    }

    [GlobalSetup]
    public void GlobalSetup()
    {
        Console.WriteLine("----------------------------------------- GlobalSetup -----------------------------------------");
        GlobalSetup().Wait();

        async Task GlobalSetup()
        {
            _serverBaseOnHoarwell = new ServerBaseOnHoarwell();
            _serverBaseOnDotNetty = new ServerBaseOnDotNetty();

            await Task.WhenAll(_serverBaseOnHoarwell.StartAsync(HoarwellPort), _serverBaseOnDotNetty.StartAsync(DotNettyPort));

            _clientBaseOnHoarwell = new ClientBaseOnHoarwell();
            _clientBaseOnDotNetty = new ClientBaseOnDotNetty();

            await Task.WhenAll(_clientBaseOnHoarwell.StartAsync(HoarwellPort, EchoCount), _clientBaseOnDotNetty.StartAsync(DotNettyPort, EchoCount));
        }
    }

    [GlobalCleanup]
    public void GlobalCleanup()
    {
        Console.WriteLine("----------------------------------------- GlobalCleanup -----------------------------------------");
        GlobalCleanup().Wait();

        async Task GlobalCleanup()
        {
            await _serverBaseOnHoarwell.DisposeAsync();
            await _serverBaseOnDotNetty.DisposeAsync();

            await _clientBaseOnHoarwell.DisposeAsync();
            await _clientBaseOnDotNetty.DisposeAsync();
        }
    }

    private static string BuildContentString(int size)
    {
        var builder = new StringBuilder(size);
        for (int i = 0; i < size; i++)
        {
            builder.Append((char)Random.Shared.Next('a', 'z' + 1));
        }
        return builder.ToString();
    }
}
